<!DOCTYPE html>
<html lang="en" ng-app="hemnetCommuterApp">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Angular -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.0/angular.min.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <!-- Leaflet Extra Markers -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.2.1/dist/js/leaflet.extra-markers.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.2.1/dist/css/leaflet.extra-markers.min.css">
  <!-- Angular Simple Logger -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-simple-logger/0.1.7/angular-simple-logger.min.js"></script>
  <!-- Angular UI for Leaflet -->
  <script src="https://cdn.jsdelivr.net/npm/ui-leaflet@1.0.3/dist/ui-leaflet.min.js"></script>
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <!-- FontAwesome -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

  <!-- Hemnet Commuter -->
  <link rel="stylesheet" href="styles.css">

  <script type="text/javascript">
    var app = angular.module("hemnetCommuterApp", ['ui-leaflet']);
    app.controller("hemnetCommuterController", [ '$scope', '$http', '$timeout', function($scope, $http, $timeout) {

      // Filters
      $scope.show_filters = false;
      $scope.show_map_settings = false;
      $scope.filters = {
        hide_ratings: {},
        kommande: "0",
        bidding: "0",
        price_min: 0,
        price_max: 10000000,
        size_total_min: 0,
      }
      $scope.stats = {
        price: [0, 10000000],
        size_total: [0, 10000],
      }

      // Settings
      $scope.map_settings = {
        marker_colour: 'none',
        marker_icon: 'none'
      }
      $scope.base_marker_colour = '#aab2b9';
      $scope.set_marker_colour = {
        'none': ['None', function(house){ return $scope.base_marker_colour; }],
        'status': ['Status', function(house){
          if(house.status == 'upcoming'){ return '#28a745'; }
          if(house.bidding == '1'){ return '#67458c'; }
          return $scope.base_marker_colour;
        }],
        'rating_combined': ['Rating: Combined', function(house){
          var score = null;
          for(let user_id in $scope.users){
            if(house.ratings[user_id] == 'yes'){ score += 1; }
            if(house.ratings[user_id] == 'maybe'){ score += 0; }
            if(house.ratings[user_id] == 'no'){ score += -1; }
          }
          if(score >= 2){ return '#28a745'; }
          if(score == 1){ return '#c3e6cb'; }
          if(score == 0){ return '#17a2b8'; }
          if(score == -1){ return '#f5c6cb'; }
          if(score <= -2){ return '#dc3545'; }
          return $scope.base_marker_colour;
        }],
      }
      $scope.base_marker_icon = 'fa-circle';
      $scope.set_marker_icon = {
        'none': ['None', function(house){ return [$scope.base_marker_icon]; }],
        'status': ['Status', function(house){
          if(house.status == 'upcoming'){ return ['fa-bolt']; }
          if(house.bidding == '1'){ return ['fa-gavel']; }
          return [$scope.base_marker_icon];
        }],
        'price': ['Price', function(house){ return ['fa-number', (house.price / 1000000).toFixed(1)] }],
        'rooms': ['Rooms', function(house){ return ['fa-number', house.rooms] }],
        'days_on_hemnet': ['Days on Hemnet', function(house){ return ['fa-number', house.days_on_hemnet] }],
      }

      // House results
      $scope.call_active = false;
      $scope.call_requested = false;
      $scope.active_id = false;
      $scope.active_house = false;
      $scope.num_total_results = 0;
      $scope.all_results = [];
      $scope.num_results = 0;
      $scope.oldest_search_result = Date.now();
      $scope.needs_update = false;
      $scope.results = [];
      $scope.users = [];
      $scope.tags = [];

      // Set up the map
      angular.extend($scope, {
        center: {},
        markers: {}
      });

      // Get the map markers
      $scope.update_results = function(init_call) {

        // Don't fire too frequently
        if($scope.call_active){
          $scope.call_requested = true;
          return;
        }
        $scope.call_active = true;
        $scope.call_requested = false;

        // Build filters POST data
        var postdata = {};
        if($scope.filters.kommande != "0"){
          postdata.kommande = $scope.filters.kommande;
        }
        if($scope.filters.bidding != "0"){
          postdata.bidding = $scope.filters.bidding;
        }
        if($scope.filters.price_min != $scope.stats.price[0]){
          postdata.price_min = $scope.filters.price_min;
        }
        if($scope.filters.price_max != $scope.stats.price[1]){
          postdata.price_max = $scope.filters.price_max;
        }
        if($scope.filters.size_total_min != $scope.stats.size_total[0]){
          postdata.size_total_min = $scope.filters.size_total_min;
        }
        for(var user_id in $scope.users){
          var ratings = [];
          if($scope.filters.hide_ratings[user_id]['yes']){ ratings.push('yes'); }
          if($scope.filters.hide_ratings[user_id]['maybe']){ ratings.push('maybe'); }
          if($scope.filters.hide_ratings[user_id]['no']){ ratings.push('no'); }
          if($scope.filters.hide_ratings[user_id]['not_set']){ ratings.push('not_set'); }
          if(ratings.length > 0){
            if(!postdata.hasOwnProperty('ratings')){
              postdata.hide_ratings = {};
            }
            postdata.hide_ratings[user_id] = ratings;
          }
        }
        console.log(postdata);

        // Get the house data from the database
        $http.post("api/houses.php", postdata).then(function(response) {

          // Assign results
          $scope.num_results = response.data.num_results;
          $scope.oldest_search_result = parseFloat(response.data.oldest_search_result + "000");
          $scope.needs_update = Date.now() - $scope.oldest_search_result > (1000*60*60*24);
          $scope.results = response.data.results;
          $scope.users = response.data.users;
          $scope.tags = response.data.tags;

          function get_min_max(key, results){
            var vals_arr = Object.values(results).map(a => parseFloat(a[key]));
            var vals_arr = vals_arr.filter(function (el) { return !isNaN(el); });
            return [ Math.min.apply(Math, vals_arr), Math.max.apply(Math, vals_arr) ];
          }

          // First time we have fetched results
          if(init_call === true){
            $scope.num_total_results = response.data.num_results;
            $scope.all_results = response.data.results;
            // Get stats
            $scope.stats.price = get_min_max('price', response.data.results);
            $scope.stats.size_total = get_min_max('size_total', response.data.results);
            // Build user-filters
            for(user_id in $scope.users){
              $scope.filters.hide_ratings[user_id] = { 'yes': false, 'maybe': false, 'no':false, 'not_set': false};
            };
            // Add extra map settings
            for(let user_id in $scope.users){
              $scope.set_marker_colour['rating_'+user_id] = ['Rating: '+$scope.users[user_id], function(house){
                if(house.ratings[user_id] == 'yes'){ return '#28a745'; }
                if(house.ratings[user_id] == 'maybe'){ return '#17a2b8'; }
                if(house.ratings[user_id] == 'no'){ return '#dc3545'; }
                return $scope.base_marker_colour;
              }];
              $scope.set_marker_icon['rating_'+user_id] = ['Rating: '+$scope.users[user_id], function(house){
                if(house.ratings[user_id] == 'yes'){ return ['fa-thumbs-up']; }
                if(house.ratings[user_id] == 'maybe'){ return ['fa-question']; }
                if(house.ratings[user_id] == 'no'){ return ['fa-thumbs-down']; }
                return [$scope.base_marker_icon];
              }];
            }
          }

          // Plot markers
          var markers = $scope.plot_markers();

          // Get new map bounds
          var l_bounds = L.latLngBounds(Object.values(markers));
          var bounds = {
            northEast: l_bounds._northEast,
            southWest: l_bounds._southWest,
          }

          // Update the map
          angular.extend($scope, {
            bounds: bounds,
            markers: markers
          });

          // Allow function to call again in 1 second
          $timeout(function () {
            $scope.call_active = false;
            if($scope.call_requested){
              $scope.update_results();
            }
          }, 1000);

        });
      };

      $scope.plot_markers = function(){
        // Make nice object of map markers
        var markers = {};
        angular.forEach($scope.results, function (house, key) {

          // Lat / Lng
          var lat = parseFloat(house.lat);
          var lng = parseFloat(house.lng);
          if(isNaN(lat) || isNaN(lng)){
            console.error("NaN for lat/lng!", lat, lng, house);
          } else {

            // Get marker colour / icon
            var m_colour = $scope.set_marker_colour[$scope.map_settings.marker_colour][1](house, 1);
            var m_icon = $scope.set_marker_icon[$scope.map_settings.marker_icon][1](house, 1);

            markers[house.house_id] = {
              house_id: house.house_id,
              lat: lat,
              lng: lng,
              message: '<h6><a href="'+house.url+'" target="_blank">'+house.streetAddress+'</a></h6><p><img src="'+house.front_image+'" style="width:100%"></p>',
              icon: {
                type: 'extraMarker',
                markerColor: m_colour,
                icon: m_icon[0],
                number: m_icon[1],
                prefix: 'fa',
                shape: 'circle',
                svg: true
              }
            }

          }
        });

        return markers;
      }

      // Replot the map markers
      $scope.update_markers = function(){
        angular.extend($scope, { markers: $scope.plot_markers() });
      }

      // Initialise the map with markers on load
      $scope.update_results(true);

      // Leaflet marker clicked
      $scope.$on('leafletDirectiveMarker.click', function(event, args){
        // Get house details
        $scope.active_id = args.model.house_id;
        $scope.active_house = $scope.results[$scope.active_id];
        console.log($scope.active_house);
      });

      // Ratings button clicked
      $scope.save_rating = function(r_user_id, rating){
        // Deselect ratings
        if(rating == $scope.active_house.ratings[r_user_id]){
          rating = 'not_set';
        }

        // Build post data and send to API
        var post_data = {
          'house_id': $scope.active_id,
          'user_id': r_user_id,
          'rating': rating
        };
        $http.post("api/ratings.php", JSON.stringify(post_data)).then(function(response) {
          // Update the scope with the new rating
          $scope.active_house.ratings[r_user_id] = rating;
          $scope.update_markers();
        });
      }

      // Comment updated
      $scope.save_comment = function(r_user_id){
        // Build post data and send to API
        var post_data = {
          'house_id': $scope.active_id,
          'user_id': r_user_id,
          'comment': $scope.active_house.comments[r_user_id]
        };
        $http.post("api/comments.php", JSON.stringify(post_data));
      }

      // Tag button clicked
      $scope.save_tag = function(tag_id){
        var selected = ! $scope.active_house.tags[tag_id];

        // Build post data and send to API
        var post_data = {
          'house_id': $scope.active_id,
          'tag_id': tag_id,
          'selected': selected
        };
        $http.post("api/tags.php", JSON.stringify(post_data)).then(function(response) {
          // Update the scope with the new tag status
          $scope.active_house.tags[tag_id] = selected;
        });
      }

      // Add tag button clicked
      $scope.add_tag = function(){
        var tag_name = prompt('New tag:');
        if(!tag_name || tag_name.trim().length == 0){
          return;
        }
        // Build post data and send to API
        var post_data = { 'new_tag': tag_name };
        $http.post("api/tags.php", JSON.stringify(post_data)).then(function(response) {
          console.log(response);
          var new_tag_id = response.data.new_tag_id;
          // Update the scope with the new tag status
          $scope.tags[new_tag_id] = tag_name;
          $scope.active_house.tags[new_tag_id] = false;
          // Update all results to have this tag
          angular.forEach($scope.results, function (house, key) {
            house.tags[new_tag_id] = false;
          });
        });
      }

    }]);
  </script>
</head>
<body ng-controller="hemnetCommuterController" style="padding:0;">

<div class="row mr-0 h-100" style="position:relative;">
  <div class="col-md-9 pl-0 h-100 order-2">
      <leaflet bounds="bounds" lf-center="center" event-broadcast="events" markers="markers" style="position: absolute; top: 0; bottom: 0; width: 100%;"></leaflet>
  </div>
  <div class="col-md-3 pr-0 order-1 h-100 overflow-auto">
    <div class="container pt-3">
      <h1 class="h2">
        <img src="hemnet.svg" class="float-right" style="width: 40px; margin-top:-5px;">
        Hemnet Commuter
      </h1>
      <hr>
      <div ng-show="needs_update">
        <a href="update.php" class="btn btn-block btn-warning"><i class="fa fa-refresh mr-2"></i> Update </a>
        <p class="small text-muted text-center mt-1">Last updated {{ oldest_search_result | date: 'yyyy-MM-dd HH:mm:ss' }}</p>
      </div>
      <div class="form-row">
        <div class="col-6"><button ng-click="show_filters = !show_filters; show_map_settings = false;" class="btn btn-block btn-secondary"><i class="fa fa-filter mr-2"></i> Filters</button></div>
        <div class="col-6"><button ng-click="show_map_settings = !show_map_settings; show_filters = false;" class="btn btn-block btn-info"><i class="fa fa-map-marker mr-2"></i> Map settings</button></div>
      </div>
      <div ng-show="show_filters" class="pt-3 mt-3 border-top">
        <h4>Filters</h4>
        <p>Showing <span ng-bind="num_results" class="badge badge-secondary"></span> out of <span ng-bind="num_total_results" class="badge badge-secondary"></span> houses.</p>
        <h6>Ratings</h6>
        <p>Click to hide houses that are any of the following:</p>
        <table class="table table-sm">
          <tr ng-repeat="(user_id, user_name) in users" ng-class="{'filter-inactive': !filters.hide_ratings[user_id]['yes'] && !filters.hide_ratings[user_id]['maybe'] && !filters.hide_ratings[user_id]['no'] && !filters.hide_ratings[user_id]['not_set'] }">
            <th>{{ user_name }}</th>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_yes_{{user_id}}" ng-model="filters.hide_ratings[user_id].yes" ng-change="update_results()">
                <label class="form-check-label" for="rating_yes_{{user_id}}">Yes</label>
            </td>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_maybe_{{user_id}}" ng-model="filters.hide_ratings[user_id].maybe" ng-change="update_results()">
                <label class="form-check-label" for="rating_maybe_{{user_id}}">Maybe</label>
            </td>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_no_{{user_id}}" ng-model="filters.hide_ratings[user_id].no" ng-change="update_results()">
                <label class="form-check-label" for="rating_no_{{user_id}}">No</label>
            </td>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_not_set_{{user_id}}" ng-model="filters.hide_ratings[user_id].not_set" ng-change="update_results()">
                <label class="form-check-label" for="rating_not_set_{{user_id}}">Not set</label>
            </td>
          </tr>
        </table>
        <h6>Basic stats</h6>
        <table class="table table-sm">
          <tr ng-class="{'filter-inactive': filters.kommande == 0}">
            <th><label for="filters_kommande">Kommande</label></th>
            <td colspan="2">
              <select id="filters_kommande" ng-model="filters.kommande" ng-change="update_results()" class="custom-select custom-select-sm">
                <option value="0">--</option>
                <option value="1">Show only Kommande</option>
                <option value="-1">Hide Kommande</option>
              </select>
            </td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.bidding == 0}">
            <th><label for="filters_bidding">Bidding</label></th>
            <td colspan="2">
              <select id="filters_bidding" ng-model="filters.bidding" ng-change="update_results()" class="custom-select custom-select-sm">
                <option value="0">--</option>
                <option value="1">Show only Bidding</option>
                <option value="-1">Hide Bidding</option>
              </select>
            </td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.price_min == stats.price[0]}">
            <th><label for="price_min">Min price</label></th>
            <td><input id="price_min" ng-model="filters.price_min" type="range" class="form-control-range" min="{{stats.price[0]}}" max="{{stats.price[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.price_min"></td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.price_max == stats.price[1]}">
            <th><label for="price_max">Max price</label></th>
            <td><input id="price_max" ng-model="filters.price_max" type="range" class="form-control-range" min="{{stats.price[0]}}" max="{{stats.price[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.price_max"></td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.size_total_min == stats.size_total[0]}">
            <th><label for="size_total_min">Min size <small style="white-space: nowrap;">(Bo + Bi)</small></label></th>
            <td><input id="size_total_min" ng-model="filters.size_total_min" type="range" class="form-control-range" min="{{stats.size_total[0]}}" max="{{stats.size_total[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.size_total_min"></td>
          </tr>
        </table>
      </div>
      <div ng-show="show_map_settings" class="pt-3 mt-3 border-top">
        <h4>Map settings</h4>
        <div class="form-row py-2">
          <div class="col">
            <label for="map_settings_marker_colour">Marker colour:</label>
          </div>
          <div class="col">
            <select id="map_settings_marker_colour" ng-model="map_settings.marker_colour" ng-change="update_markers()" class="custom-select custom-select-sm">
              <option ng-repeat="(key, m_func) in set_marker_colour" value="{{ key }}">{{ m_func[0] }}</option>
            </select>
          </div>
        </div>
        <div class="form-row py-2 border-top">
          <div class="col">
            <label for="map_settings_marker_icon">Marker icon:</label>
          </div>
          <div class="col">
            <select id="map_settings_marker_icon" ng-model="map_settings.marker_icon" ng-change="update_markers()" class="custom-select custom-select-sm">
              <option ng-repeat="(key, m_func) in set_marker_icon" value="{{ key }}">{{ m_func[0] }}</option>
            </select>
          </div>
        </div>
      </div>
      <div ng-show="active_id == false" class="text-muted pt-3 mt-3 border-top">Click a house marker on the map to see more information here.</div>
      <div ng-hide="active_id == false" class="pt-3 mt-3 border-top">
        <h3><a ng-href="{{active_house.url}}" target="_blank"><span ng-bind="active_house.streetAddress"></span> <i class="fa fa-external-link" aria-hidden="true"></i></a></h3>
        <h3>
          <span class="badge" ng-class="{'badge-success': active_house.price < 4000000, 'badge-primary': active_house.price > 4000000 && active_house.price < 5700000, 'badge-danger': active_house.price > 5700000}"><span ng-bind="active_house.price / 1000000 | number:3"></span> MKr</span>
          <span class="float-right small mt-2">
            <span ng-show="active_house.status == 'upcoming'" class="badge badge-success"><i class="fa fa-bolt mr-2" aria-hidden="true"></i>Kommande</span>
            <span ng-show="active_house.bidding == 1" class="badge badge-info" style="background-color: #67458c;"><i class="fa fa-gavel mr-2" aria-hidden="true"></i> Budgivning pågår</span>
          </span>
        </h3>
        <img ng-src="{{active_house.front_image}}" class="w-100 my-2">
        <table class="table table-sm small table-hover">
          <tr>
            <th>Location:</th>
            <td ng-bind="active_house.addressLocality"></td>
          </tr>
          <tr>
            <th>Published:</th>
            <td>
              <span ng-bind="active_house.publication_date"></span>
            </td>
          </tr>
          <tr>
            <th style="white-space: nowrap;">Upcoming visning:</th>
            <td>
              <span ng-bind="active_house.upcoming_open_houses == 1 ? 'Yes' : 'No'"></span>
            </td>
          </tr>
          <tr>
            <th>Size:</th>
            <td>
              <span ng-bind="(active_house.living_area * 1) + (active_house.supplemental_area * 1)"></span> m<sup>2</sup>
              <small>(<span ng-bind="active_house.living_area"></span> Bo <span ng-show="active_house.supplemental_area > 0">+ <span ng-bind="active_house.supplemental_area"></span> Bi</span>)</small>
            </td>
          </tr>
          <tr>
            <th>Tomt:</th>
            <td>
              <span ng-bind="active_house.land_area | number:0"></span> m<sup>2</sup>
            </td>
          </tr>
          <tr>
            <th>Rooms:</th>
            <td><span ng-bind="active_house.rooms"></span></td>
          </tr>
          <tr ng-show="active_house.driftkostnad > 0">
            <th>Driftkostnad:</th>
            <td><span ng-bind="active_house.driftkostnad | number:0"></span> kr/year <small>( <span ng-bind="active_house.driftkostnad / 12 | number:0"></span> kr/month)</small></td>
          </tr>
          <tr>
            <th>Construction:</th>
            <td><span ng-bind="active_house.construction_year"></span></td>
          </tr>
          <tr>
            <th>Tenure:</th>
            <td><span ng-bind="active_house.tenure"></span></td>
          </tr>
          <tr ng-show="active_house.days_on_hemnet">
            <th>Days on Hemnet:</th>
            <td><span ng-bind="active_house.days_on_hemnet"></span></td>
          </tr>
        </table>

        <div class="row my-5 house_ratings">
          <div ng-repeat="(user_id, user_name) in users" class="col-6">
            <h5>{{ user_name }}</h5>
            <div class="btn-group d-flex" role="group">
              <button ng-click="save_rating(user_id, 'yes')" ng-class="{'active': active_house.ratings[user_id] == 'yes'}"  class="btn w-100 btn-outline-success"><i class="fa fa-thumbs-up"></i></button>
              <button ng-click="save_rating(user_id, 'maybe')" ng-class="{'active': active_house.ratings[user_id] == 'maybe'}"  class="btn w-100 btn-outline-info"><i class="fa fa-question"></i></button>
              <button ng-click="save_rating(user_id, 'no')" ng-class="{'active': active_house.ratings[user_id] == 'no'}"  class="btn w-100 btn-outline-danger"><i class="fa fa-thumbs-down"></i></button>
            </div>
            <textarea ng-model="active_house.comments[user_id]" ng-change="save_comment(user_id)" ng-model-options="{ updateOn: 'default blur', debounce: {'default': 500, 'blur': 0} }" class="form-control form-control-sm my-2" placeholder="Comment"></textarea>
          </div>
          <div class="col-12">
            <h6>
              Tags
              <button ng-click="add_tag()" class="btn btn-sm btn-link text-muted" style="font-size: .7rem;">[add tag]</button>
            </h6>
            <button ng-repeat="(tag_id, selected) in active_house.tags" ng-click="save_tag(tag_id)" ng-class="{'active': selected}" class="btn btn-outline-secondary p-1 mr-2 mb-2" style="font-size: .7rem;">{{tags[tag_id]}}</button>
          </div>
        </div>
        <p class="p-3 mb-2 bg-success text-white" style="display:none;" id="saving_ratings_notification">Saving ratings..</p>
      </div>
    </div>
    <footer>
        Hemnet-Commuter was written by <a href="http://phil.ewels.co.uk">Phil Ewels</a>. It is in no way connected with, or endorsed by,
        <a href="https://www.hemnet.se">hemnet.se</a>.<br>
        The code for this website is released with the MIT open-source licence and can be
        viewed on GitHub: <a href="https://github.com/ewels/hemnet-commuter">https://github.com/ewels/hemnet-commuter</a>.
    </footer>
  </div>
</div>

</body>
</html>
